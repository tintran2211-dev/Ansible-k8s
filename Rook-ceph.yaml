---
- name: Triển khai Rook Ceph trên Kubernetes
  hosts: server
  become: yes
  tasks:
    - name: Clone repository Rook
      ansible.builtin.git:
        repo: https://github.com/rook/rook.git
        dest: /path/to/destination/rook
        version: v1.14.6
        single_branch: yes

    # - name: Chuyển sang đường dẫn rook/deploy/examples
    #   ansible.builtin.shell: "cd /path/to/destination/rook/deploy/examples"
    #   args:
    #     chdir: /path/to/destination/rook/deploy/examples

    - name: Khởi tạo rook-ceph operator
      ansible.builtin.command:
        cmd: kubectl create -f crds.yaml -f common.yaml -f operator.yaml
      args:
        chdir: /home/tctin/rook/deploy/examples

    - name: Kiểm tra trạng thái của pod rook-ceph-operator
      ansible.builtin.shell: 
        cmd: kubectl get pods -n rook-ceph -l app=rook-ceph-operator -o jsonpath='{.items[0].status.phase}'
      register: operator_status
      retries: 5
      delay: 40
      until: operator_status.stdout == "Running"

    - name: Tạo rook-ceph cluster nếu pod rook-ceph-operator đang chạy
      ansible.builtin.command:
        cmd: kubectl create -f cluster.yaml
      args:
        chdir: /path/to/destination/rook/deploy/examples
      when: operator_status.stdout == "Running"
